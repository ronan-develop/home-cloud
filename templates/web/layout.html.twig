{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('styles/main.css') }}">
{% endblock %}
{% extends 'base.html.twig' %}

{% block body %}

<div class="layout-root" style="display:flex; min-height:100vh;">

    {# â”€â”€ Sidebar â”€â”€ #}
    <aside class="sidebar" style="width:250px; min-width:220px; background:#f3f4f6; border-right:1.5px solid #e5e7eb; display:flex; flex-direction:column; flex-shrink:0;">

        {# Header : logo + bouton Nouveau #}
        <div class="sidebar-header" style="display:flex; flex-direction:column; align-items:flex-start; gap:1.2rem; padding:2rem 1.2rem 1rem 1.2rem;">
            <a href="{{ path('app_home') }}" style="display:flex; align-items:center; gap:0.5rem; text-decoration:none; color:#111827; font-weight:700; font-size:1.1rem;">
                <span>â˜ï¸</span>
                <span>HomeCloud</span>
            </a>
            <twig:NewMenu />
        </div>

        {# Navigation #}
        <nav style="display:flex; flex-direction:column; gap:0.3rem; padding:0 0.75rem;">
            {% set nav_items = [
                { route: 'app_home', icon: 'ğŸ“', label: 'Mes fichiers' },
                { route: '#',        icon: 'ğŸ–¼ï¸', label: 'Galerie' },
                { route: '#',        icon: 'ğŸ“š', label: 'Albums' },
                { route: '#',        icon: 'ğŸ”—', label: 'Partages' },
            ] %}
            {% for item in nav_items %}
                <a href="{{ item.route starts with '#' ? '#' : path(item.route) }}"
                   style="display:flex; align-items:center; gap:0.65rem; padding:0.55rem 0.85rem; border-radius:0.6rem; font-size:0.875rem; color:#374151; text-decoration:none; transition:background 0.15s;"
                   onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='transparent'">
                    <span>{{ item.icon }}</span>
                    {{ item.label }}
                </a>
            {% endfor %}
        </nav>

        {# Footer : user + logout #}
        <div style="margin-top:auto; padding:1rem 1.2rem; border-top:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; gap:0.5rem;">
            <span style="font-size:0.8rem; color:#6b7280; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ app.user.displayName }}</span>
            <a href="{{ path('app_logout') }}" style="font-size:0.8rem; color:#ef4444; text-decoration:none; white-space:nowrap; flex-shrink:0;">DÃ©connexion</a>
        </div>
    </aside>

    {# â”€â”€ Main â”€â”€ #}
    <main style="flex:1; background:#181f2a; padding:2.5rem; min-height:100vh; display:flex; flex-direction:column; gap:2.2rem; overflow:auto; color:#f9fafb;">

        {# Flash messages #}
        {% for type, messages in app.flashes %}
            {% for message in messages %}
                <div class="flash-{{ type }}"
                     style="padding:0.75rem 1rem; border-radius:0.75rem; font-size:0.875rem;
                            {% if type == 'error' %}background:#fef2f2; color:#dc2626; border:1px solid #fecaca;
                            {% elseif type == 'success' %}background:#f0fdf4; color:#16a34a; border:1px solid #bbf7d0;
                            {% else %}background:#eff6ff; color:#2563eb; border:1px solid #bfdbfe;{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        {% block content %}{% endblock %}
    </main>
</div>

{# === Modal sÃ©lection dossier pour upload === #}
<div id="upload-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
        <div class="flex items-center justify-between mb-1">
            <h2 class="text-base font-semibold text-gray-800 dark:text-gray-100">Importer</h2>
            <button onclick="closeModal('upload-modal')" class="text-gray-400 hover:text-gray-600 text-xl leading-none">Ã—</button>
        </div>
        <p id="upload-filename" class="text-sm text-gray-500 mb-4 truncate"></p>

        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Destination</p>
        <div data-testid="upload-folder-list" class="flex flex-col gap-1 max-h-48 overflow-y-auto mb-3">
            <button type="button" onclick="selectUploadFolder('', this)"
                    class="folder-opt active-folder flex items-center gap-2 px-3 py-2 rounded-xl text-sm text-left transition-colors">
                <span>ğŸ </span> Mes fichiers (racine)
            </button>
            {% for folder in userFolders %}
                <button type="button" onclick="selectUploadFolder('{{ folder.id }}', this)"
                        class="folder-opt flex items-center gap-2 px-3 py-2 rounded-xl text-sm text-left
                               text-gray-600 hover:bg-blue-50 transition-colors">
                    <span>ğŸ“</span> {{ folder.name }}
                </button>
            {% endfor %}
        </div>

        <div class="border-t border-gray-100 pt-3 mb-4">
            <input type="text" id="new-folder-name" placeholder="Ou crÃ©er un nouveau dossierâ€¦"
                   oninput="onNewFolderName(this.value)"
                   class="w-full px-3 py-2 text-sm border border-gray-200 rounded-xl bg-transparent
                          focus:outline-none focus:ring-2 focus:ring-blue-400/50 dark:border-gray-700
                          dark:text-white dark:placeholder-gray-500">
        </div>

        <div id="upload-progress" class="hidden mb-3">
            <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                <div id="upload-progress-bar" class="h-full bg-blue-500 transition-all duration-300" style="width:0%"></div>
            </div>
            <p id="upload-progress-label" class="text-xs text-gray-400 mt-1"></p>
        </div>

        <div class="flex gap-2 justify-end">
            <button onclick="closeModal('upload-modal')"
                    class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 rounded-xl transition-colors">
                Annuler
            </button>
            <button id="upload-submit-btn" onclick="submitUpload()"
                    class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold
                           rounded-xl transition-colors disabled:opacity-50">
                Uploader â¬†ï¸
            </button>
        </div>
    </div>
</div>

{# === Modal nouveau dossier === #}
<div id="new-folder-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-base font-semibold text-gray-800 dark:text-gray-100">Nouveau dossier</h2>
            <button onclick="closeModal('new-folder-modal')" class="text-gray-400 hover:text-gray-600 text-xl leading-none">Ã—</button>
        </div>
        <input type="text" id="new-folder-input" placeholder="Nom du dossier"
               class="w-full px-3 py-2 text-sm border border-gray-200 rounded-xl bg-transparent
                      focus:outline-none focus:ring-2 focus:ring-blue-400/50 dark:border-gray-700
                      dark:text-white mb-4">
        <div class="flex gap-2 justify-end">
            <button onclick="closeModal('new-folder-modal')"
                    class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 rounded-xl transition-colors">
                Annuler
            </button>
            <button onclick="submitNewFolder()"
                    class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold
                           rounded-xl transition-colors">
                CrÃ©er
            </button>
        </div>
    </div>
</div>

<script>
(function () {
    // â”€â”€ Token bridge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var _token = null;
    var _tokenExp = 0;

    window.HC = {
        getToken: async function () {
            if (_token && Date.now() < _tokenExp) return _token;
            var res = await fetch('{{ path('app_web_token') }}');
            var data = await res.json();
            _token = data.token;
            _tokenExp = Date.now() + 14 * 60 * 1000; // 14 min
            return _token;
        }
    };

    // â”€â”€ Menu Nouveau â€” gÃ©rÃ© par new_menu_controller.js (Stimulus) â”€â”€â”€â”€â”€â”€â”€
    // Ã‰coute les events CustomEvent Ã©mis par le controller
    document.addEventListener('new-menu:open-folder-modal', function () {
        document.getElementById('new-folder-input').value = '';
        document.getElementById('new-folder-modal').classList.remove('hidden');
        document.getElementById('new-folder-input').focus();
    });
    document.addEventListener('new-menu:file-selected', function (e) {
        var file = e.detail.file;
        _pendingFile = file;
        _uploadFolderId = '';
        document.getElementById('upload-filename').textContent = '\uD83D\uDCCE ' + file.name;
        document.getElementById('new-folder-name').value = '';
        document.querySelectorAll('.folder-opt').forEach(function (el) {
            el.classList.remove('active-folder', 'bg-blue-50', 'text-blue-700');
            el.classList.add('text-gray-600');
        });
        var first = document.querySelector('.folder-opt');
        if (first) { first.classList.add('active-folder', 'bg-blue-50', 'text-blue-700'); first.classList.remove('text-gray-600'); }
        document.getElementById('upload-progress').classList.add('hidden');
        document.getElementById('upload-modal').classList.remove('hidden');
    });

    window.selectUploadFolder = function (id, btn) {
        _uploadFolderId = id;
        document.getElementById('new-folder-name').value = '';
        document.querySelectorAll('.folder-opt').forEach(function (el) {
            el.classList.remove('active-folder', 'bg-blue-50', 'text-blue-700');
            el.classList.add('text-gray-600');
        });
        btn.classList.add('active-folder', 'bg-blue-50', 'text-blue-700');
        btn.classList.remove('text-gray-600');
    };

    window.onNewFolderName = function (val) {
        _uploadFolderId = '';
        document.querySelectorAll('.folder-opt').forEach(function (el) {
            el.classList.remove('active-folder', 'bg-blue-50', 'text-blue-700');
            el.classList.add('text-gray-600');
        });
    };

    window.submitUpload = async function () {
        if (!_pendingFile) return;
        var btn = document.getElementById('upload-submit-btn');
        btn.disabled = true;

        var token = await HC.getToken();
        var fd = new FormData();
        fd.append('file', _pendingFile);
        fd.append('ownerId', '{{ app.user.id }}');

        var newFolder = document.getElementById('new-folder-name').value.trim();
        if (newFolder) {
            fd.append('newFolderName', newFolder);
        } else if (_uploadFolderId) {
            fd.append('folderId', _uploadFolderId);
        }

        var progress = document.getElementById('upload-progress');
        var bar = document.getElementById('upload-progress-bar');
        var label = document.getElementById('upload-progress-label');
        progress.classList.remove('hidden');

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '{{ path('_api_/v1/files_post') }}');
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
                var pct = Math.round(e.loaded / e.total * 100);
                bar.style.width = pct + '%';
                label.textContent = pct + '%';
            }
        };
        xhr.onload = function () {
            if (xhr.status === 201) {
                closeModal('upload-modal');
                window.location.reload();
            } else {
                label.textContent = 'Erreur lors de l\'upload.';
                btn.disabled = false;
            }
        };
        xhr.send(fd);
    };

    // â”€â”€ Nouveau dossier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('new-folder-input').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') submitNewFolder();
        if (e.key === 'Escape') closeModal('new-folder-modal');
    });

    window.submitNewFolder = async function () {
        var name = document.getElementById('new-folder-input').value.trim();
        if (!name) return;
        var token = await HC.getToken();
        var res = await fetch('{{ path('_api_/v1/folders_post') }}', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: name }),
        });
        if (res.ok) {
            closeModal('new-folder-modal');
            window.location.reload();
        }
    };

    // â”€â”€ EmpÃªche ouverture browser sur drop hors zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function blockBrowser(e) { e.preventDefault(); }
    window.addEventListener('dragover', blockBrowser, true);
    window.addEventListener('drop',     blockBrowser, true);

    // â”€â”€ Import dossier (stub â€” feature future) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.onFolderSelected = function (input) {
        input.value = '';
        alert('Import de dossier â€” bientÃ´t disponible ğŸš§');
    };
})();
</script>

{% endblock %}
