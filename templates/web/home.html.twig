{% extends 'web/layout.html.twig' %}

{% block title %}Mes fichiers â€” HomeCloud{% endblock %}

{% block content %}

{# === Zone upload drag & drop === #}
<div data-testid="upload-zone"
     data-controller="file-upload"
     data-file-upload-folder-id-value="{{ currentFolder ? currentFolder.id : '' }}"
     class="upload-zone mb-6">

    <form method="post" action="{{ path('app_file_upload') }}" enctype="multipart/form-data"
          data-file-upload-target="form">
        <input type="hidden" name="folder_id" value="{{ currentFolder ? currentFolder.id : '' }}">
        <input type="file" name="file" data-file-upload-target="input" class="hidden"
               data-action="change->file-upload#fileSelected">

        <div data-file-upload-target="idle">
            <p class="text-3xl mb-2">â˜ï¸</p>
            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">
                Glissez un fichier ici
            </p>
            <p class="text-xs text-gray-400 mt-1">ou</p>
            <button type="button" data-action="file-upload#browse"
                    class="mt-2 text-sm text-blue-600 hover:text-blue-700 font-medium underline underline-offset-2">
                parcourir
            </button>
        </div>

        <div data-file-upload-target="ready" class="hidden">
            <p class="text-sm font-medium text-gray-700 dark:text-gray-200" data-file-upload-target="filename"></p>
            <button type="submit"
                    class="mt-3 px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-xl transition-colors">
                Uploader
            </button>
            <button type="button" data-action="file-upload#reset"
                    class="mt-3 ml-2 px-4 py-2 text-sm text-gray-500 hover:text-gray-700 rounded-xl transition-colors">
                Annuler
            </button>
        </div>
    </form>
</div>

{# === Explorateur === #}
<div data-testid="file-explorer" class="flex gap-4">

    {# Sidebar dossiers #}
    <aside class="w-48 shrink-0">
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-2 mb-2">Dossiers</h3>

        <a href="{{ path('app_home') }}"
           class="flex items-center gap-2 px-3 py-2 rounded-xl text-sm transition-all
                  {% if currentFolder is null %}bg-blue-50 text-blue-700 dark:bg-blue-950/50 dark:text-blue-300{% else %}text-gray-600 hover:bg-white/80 hover:text-gray-900{% endif %}">
            <span>ğŸ </span> Tous les fichiers
        </a>

        {% for folder in folders %}
            <a href="{{ path('app_home', { folder: folder.id }) }}"
               class="flex items-center gap-2 px-3 py-2 rounded-xl text-sm transition-all
                      {% if currentFolder and currentFolder.id == folder.id %}bg-blue-50 text-blue-700 dark:bg-blue-950/50 dark:text-blue-300{% else %}text-gray-600 hover:bg-white/80 hover:text-gray-900{% endif %}">
                <span>ğŸ“</span> {{ folder.name }}
            </a>
        {% endfor %}
    </aside>

    {# Liste fichiers #}
    <div class="flex-1" data-testid="file-list">
        {% if currentFolder %}
            <div class="flex items-center gap-2 text-sm text-gray-500 mb-3">
                <a href="{{ path('app_home') }}" class="hover:text-blue-600">Accueil</a>
                <span>/</span>
                <span class="font-medium text-gray-700 dark:text-gray-200">{{ currentFolder.name }}</span>
            </div>
        {% endif %}

        {% if files is empty %}
            <div class="text-center py-16 text-gray-400">
                <p class="text-4xl mb-3">ğŸ“‚</p>
                <p class="text-sm">Aucun fichier ici</p>
                <p class="text-xs mt-1">Glissez un fichier pour commencer</p>
            </div>
        {% else %}
            <div class="flex flex-col gap-1">
                {% for file in files %}
                    <div class="flex items-center gap-3 px-4 py-3 rounded-2xl bg-white/60 dark:bg-white/5
                                border border-white/40 dark:border-white/10 hover:shadow-sm transition-all group">

                        {# IcÃ´ne type #}
                        <span class="text-xl shrink-0">
                            {% if file.mimeType starts with 'image/' %}ğŸ–¼ï¸
                            {% elseif file.mimeType starts with 'video/' %}ğŸ¬
                            {% elseif file.mimeType starts with 'audio/' %}ğŸµ
                            {% elseif file.mimeType == 'application/pdf' %}ğŸ“„
                            {% else %}ğŸ“{% endif %}
                        </span>

                        {# Nom + infos #}
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-800 dark:text-gray-100 truncate">
                                {{ file.originalName }}
                            </p>
                            <p class="text-xs text-gray-400">
                                {{ file.size | number_format(0, ',', ' ') }} o
                                Â· {{ file.createdAt | date('d/m/Y') }}
                                {% if file.isNeutralized %}<span class="text-amber-500 ml-1" title="Fichier neutralisÃ©">âš ï¸</span>{% endif %}
                            </p>
                        </div>

                        {# Actions #}
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <a href="{{ path('app_file_download', { id: file.id }) }}"
                               class="p-2 rounded-lg text-gray-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-950/40 transition-colors"
                               title="TÃ©lÃ©charger">
                                â¬‡ï¸
                            </a>
                            <form method="post" action="{{ path('app_file_delete', { id: file.id }) }}"
                                  onsubmit="return confirm('Supprimer Â« {{ file.originalName|e('js') }} Â» ?')">
                                <input type="hidden" name="folder_id" value="{{ currentFolder ? currentFolder.id : '' }}">
                                <button type="submit"
                                        class="p-2 rounded-lg text-gray-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-950/40 transition-colors"
                                        title="Supprimer">
                                    ğŸ—‘ï¸
                                </button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

</div>

{% endblock %}

