<div id="new-menu-btn-wrapper" class="relative mb-2">

    <button id="new-menu-btn"
            data-testid="new-btn"
            type="button"
            class="w-full flex items-center gap-2 px-4 py-2.5 rounded-2xl
                   bg-white border border-gray-200 shadow-sm hover:shadow-md
                   text-sm font-semibold text-gray-700 transition-all cursor-pointer">
        <span class="text-lg font-light">ï¼‹</span> Nouveau
    </button>

</div>

{# Menu rendu au niveau du body pour Ã©chapper aux stacking contexts #}
<div id="new-menu"
     data-testid="new-menu"
     class="hidden fixed bg-white rounded-2xl shadow-xl border border-gray-100 py-1 z-[9999] w-52">

    <button id="new-menu-new-folder-btn"
            data-testid="new-menu-new-folder"
            type="button"
            class="w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700
                   hover:bg-gray-50 transition-colors text-left cursor-pointer">
        <span>ğŸ“</span> Nouveau dossier
    </button>

    <hr class="my-1 border-gray-100">

    <label data-testid="new-menu-import-file"
           class="w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700
                  hover:bg-gray-50 transition-colors cursor-pointer">
        <span>ğŸ“„</span> Importer un fichier
        <input type="file" id="new-menu-file-input" class="hidden">
    </label>

    <label data-testid="new-menu-import-folder"
           class="w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700
                  hover:bg-gray-50 transition-colors cursor-pointer">
        <span>ğŸ“‚</span> Importer un dossier
        <input type="file" id="new-menu-folder-input" webkitdirectory multiple class="hidden">
    </label>
</div>

<script>
(function () {
    var btn        = document.getElementById('new-menu-btn');
    var menu       = document.getElementById('new-menu');
    var folderBtn  = document.getElementById('new-menu-new-folder-btn');
    var fileInput  = document.getElementById('new-menu-file-input');
    var folderInput = document.getElementById('new-menu-folder-input');

    function positionMenu() {
        var rect = btn.getBoundingClientRect();
        menu.style.top   = (rect.bottom + 4) + 'px';
        menu.style.left  = rect.left + 'px';
        menu.style.width = rect.width + 'px';
    }

    function openMenu() {
        positionMenu();
        menu.classList.remove('hidden');
    }

    function closeMenu() {
        menu.classList.add('hidden');
    }

    btn.addEventListener('click', function (e) {
        e.stopPropagation();
        menu.classList.contains('hidden') ? openMenu() : closeMenu();
    });

    folderBtn.addEventListener('click', function () {
        closeMenu();
        document.dispatchEvent(new CustomEvent('new-menu:open-folder-modal'));
    });

    fileInput.addEventListener('change', function () {
        var file = fileInput.files[0];
        fileInput.value = '';
        if (!file) return;
        closeMenu();
        document.dispatchEvent(new CustomEvent('new-menu:file-selected', { detail: { file: file } }));
    });

    folderInput.addEventListener('change', function () {
        folderInput.value = '';
        closeMenu();
        alert('Folder import â€” coming soon ğŸš§');
    });

    document.addEventListener('click', function (e) {
        if (!btn.contains(e.target) && !menu.contains(e.target)) {
            closeMenu();
        }
    });
}());
</script>
